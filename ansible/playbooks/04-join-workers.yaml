---
- name: Join worker nodes to Kubernetes cluster
  hosts: workers
  become: yes

  vars:
    join_command: "{{ lookup('file', './artifacts/kubeadm_join.sh') }}"

  tasks:
    # 1. Disable swap
    - name: Disable swap
      command: swapoff -a

    - name: Remove any swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^(.+swap.+)$'
        replace: '# \1'

    # 2. Load required kernel modules
    - name: Load required kernel modules
      copy:
        dest: /etc/modules-load.d/kubernetes.conf
        content: |
          overlay
          br_netfilter

    - name: Load modules immediately
      shell: |
        modprobe overlay
        modprobe br_netfilter

    # 3. Apply sysctl settings
    - name: Apply sysctl params for Kubernetes networking
      copy:
        dest: /etc/sysctl.d/kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Reload sysctl
      command: sysctl --system

    # 4. Join node to the cluster
    - name: Join node to the cluster
      shell: "{{ join_command }} --cri-socket unix:///run/containerd/containerd.sock"
      args:
        creates: /etc/kubernetes/kubelet.conf
