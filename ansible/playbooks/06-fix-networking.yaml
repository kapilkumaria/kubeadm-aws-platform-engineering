---
- name: Fix Kubernetes networking for Calico & kube-proxy
  hosts: kubernetes
  become: yes

  tasks:
    - name: Load required kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          br_netfilter
          overlay
      notify:
        - Load modules now

    - name: Apply sysctl settings for Kubernetes networking
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
      notify:
        - Apply sysctl

  handlers:
    - name: Load modules now
      command: modprobe br_netfilter && modprobe overlay

    - name: Apply sysctl
      command: sysctl --system
